"use strict";var Z=Object.create;var N=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var tt=Object.getOwnPropertyNames;var et=Object.getPrototypeOf,rt=Object.prototype.hasOwnProperty;var ot=(o,n)=>{for(var i in n)N(o,i,{get:n[i],enumerable:!0})},D=(o,n,i,s)=>{if(n&&typeof n=="object"||typeof n=="function")for(let c of tt(n))!rt.call(o,c)&&c!==i&&N(o,c,{get:()=>n[c],enumerable:!(s=K(n,c))||s.enumerable});return o};var at=(o,n,i)=>(i=o!=null?Z(et(o)):{},D(n||!o||!o.__esModule?N(i,"default",{value:o,enumerable:!0}):i,o)),it=o=>D(N({},"__esModule",{value:!0}),o);var dt={};ot(dt,{ChatUI:()=>T,init:()=>R});module.exports=it(dt);var Y=at(require("react-dom/client"),1);var h=require("react"),P=require("iconsax-react");var l=require("react"),x=require("lucide-react"),k=require("iconsax-react"),e=require("react/jsx-runtime");function $({apiKey:o,openAi:n}){let[i,s]=(0,l.useState)(""),[c,u]=(0,l.useState)([]),v=(0,l.useRef)(null),[I,z]=(0,l.useState)(""),[S,y]=(0,l.useState)(null),[b,_]=(0,l.useState)(!1),[w,j]=(0,l.useState)(null),[C,M]=(0,l.useState)(()=>sessionStorage.getItem("aiPaused")==="true"),[E,X]=(0,l.useState)(null),[A,G]=(0,l.useState)(!1);(0,l.useEffect)(()=>{sessionStorage.setItem("aiPaused",C.toString())},[C]);let f="https://hostie-dashboard.vercel.app/api/clientCustomerChatBox";(0,l.useEffect)(()=>{v.current?.scrollIntoView({behavior:"smooth"})},[c]),(0,l.useEffect)(()=>{(async()=>{try{let r=sessionStorage.getItem("guestContactId"),a=sessionStorage.getItem("room"),p=sessionStorage.getItem("guestContactId");if(r){z(r),y(r);let d=await(await fetch(`${f}/getGuestRoom?guest_id=${r}`,{headers:{"x-api-key":o}})).json();j(d.room_id)}else{let g=crypto.randomUUID();j(g),_(!0),y(null)}}catch(r){console.error("Error setting up room:",r)}})()},[]),(0,l.useEffect)(()=>{(async()=>{if(w&&I)try{let r=await fetch(`${f}/getChatHistory?room_id=${w}`,{headers:{"x-api-key":o}}),a=await r.json();if(!r.ok){console.error("Failed to fetch chat history:",a.error);return}let g=(a.data||[]).filter(d=>!d.resolved&&!d.deleted).map(d=>({sender:d.sender_id||d.guest_sender_id?"user":"bot",text:d.message,uploaded_documents:d.uploaded_documents||null,timestamps:{sent:d.sender_id||d.guest_sender_id?new Date(d.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):void 0,received:!d.sender_id&&!d.guest_sender_id?new Date(d.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):void 0}}));u(g)}catch(r){console.error("Unexpected error fetching chat history:",r)}})()},[w]),(0,l.useEffect)(()=>{if(!w)return;let t=new EventSource(`${f}/stream?room=${w}&api_key=${o}`);return t.onmessage=r=>{if(!(r.data==="ping"||r.data==="connected"))try{let a=JSON.parse(r.data);if(!a||!a.message||a.deleted)return;let p=a.message.trim();if(p==="You are now connected to a live agent. AI responses are paused."){M(!0),L(p);return}if(p==="AI responses resumed."){M(!1),L(p);return}u(g=>[...g,{sender:a.sender_id||a.guest_sender_id?"user":"bot",text:a.message,timestamps:{received:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}}])}catch(a){console.error("SSE parse error:",a)}},t.onerror=r=>{console.error("SSE connection error:",r),t.close()},()=>t.close()},[w]);let J=async t=>{let r=await fetch(`${f}/saveContact`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":o},body:JSON.stringify(t)});if(!r.ok){let p=await r.text();throw new Error(`Failed to save contact: ${r.status} ${p}`)}return await r.json()},U=async(t,r)=>(await fetch(`${f}/saveMessage`,{method:"POST",headers:{"Content-Type":"application/json","x-openai-key":n,"x-api-key":o},body:JSON.stringify({prompt:t,room_id:w,sender_id:S,receiver_id:C?"live_agent":"ai",skipAI:r})})).json(),q=async(t,r,a)=>(await fetch(`${f}/saveMessage`,{method:"POST",headers:{"Content-Type":"application/json","x-openai-key":n,"x-api-key":o},body:JSON.stringify({prompt:t,room_id:w,sender_id:a,receiver_id:C?"live_agent":"ai",skipAI:r})})).json(),O=async(t,r,a)=>{await fetch(`${f}/saveAiMessage`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":a},body:JSON.stringify({room_id:w,message:t,receiver_id:r})})},L=t=>{u(r=>[...r,{sender:"bot",text:t,timestamps:{received:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}}])},V=t=>{u(r=>[...r,{sender:"user",text:t,timestamps:{sent:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}}])},F=async()=>{if(!i.trim())return;let t=i.trim();if(s(""),b&&!E&&!A){V(t),G(!0),await O("Before we continue, could you please share your name or email?",S,o);return}if(A&&!E)if(w){let r=i.includes("@")?{email:i,room_id:w}:{name:i,room_id:w};try{let a=await J(r);sessionStorage.setItem("guestContactId",a.id),z(a.id),y(a.id),X({name:a.name,email:a.email}),sessionStorage.setItem("room",a.room_id),j(a.room_id),sessionStorage.setItem("guestContactId",a.id),await q(i,!0,a.id);let p=`Thanks ${a.name||a.email}! You can continue chatting now..!`;await O(p,a.id,o)}catch(a){console.error("Error saving guest info:",a)}return}else console.log("no room name there....");if(C){console.log("AI response paused due to live agent assignment.");let r=await U(t,!0)}else try{let a=(await U(t,!1)).reply||"Sorry, I couldn't generate a reply."}catch(r){console.error("AI call failed:",r)}},W=async t=>{if(!w||!S){alert("provide your details First..!");return}if(!["image/jpeg","image/png","image/gif","application/pdf","audio/mpeg","audio/wav","audio/ogg"].includes(t.type)){let g=t.type||t.name.split(".").pop();alert(`\u274C Unsupported file type: ${g}`);return}let a=50*1024*1024;if(t.size>a){alert(`\u274C File too large! (${(t.size/1024/1024).toFixed(1)} MB > 50 MB limit)`);return}let p=new FormData;p.append("file",t),p.append("room_id",w),p.append("sender_id",S);try{let g=await fetch(`${f}/uploadFile`,{method:"POST",headers:{"x-api-key":o},body:p}),d=await g.json();if(!g.ok){alert("File upload failed. Please try again."),console.error("Upload error:",d.error);return}if(!d.fileUrl){alert("Unexpected error: no file URL returned.");return}u(Q=>[...Q,{sender:"user",text:t.name,uploaded_documents:d.fileUrl,timestamps:{sent:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}}])}catch(g){console.error("File upload failed:",g),alert("Something went wrong while uploading. Please try again.")}};return(0,e.jsx)("div",{className:"fixed bottom-6 right-6 z-50",children:(0,e.jsxs)("div",{id:"hostie-chat-box",className:"flex flex-col w-[340px] h-[85vh] rounded-2xl shadow-xl border border-zinc-200 bg-white dark:bg-neutral-800 overflow-hidden",children:[(0,e.jsxs)("div",{className:"flex items-center justify-between p-3 border-b border-zinc-200 dark:border-neutral-700",children:[(0,e.jsxs)("div",{className:"flex items-center gap-2",children:[(0,e.jsx)(k.Wanchain,{className:"text-purple-600",variant:"Bold"}),(0,e.jsx)("span",{className:"font-semibold text-sm",children:"Hostie"}),(0,e.jsx)("span",{className:"ml-1 h-2 w-2 rounded-full bg-green-500"}),(0,e.jsx)("span",{className:"text-xs text-green-500",children:"Online"})]}),(0,e.jsxs)("div",{className:"flex items-center px-2 py-0.5 rounded-md bg-purple-50 dark:bg-purple-800",children:[(0,e.jsx)(x.Bot,{size:12,className:"text-zinc-600 dark:text-zinc-200"}),(0,e.jsx)("span",{className:"ml-1 text-xs font-medium",children:"AI"})]})]}),(0,e.jsxs)("div",{className:"flex-1 overflow-y-auto p-3 space-y-2",children:[c.length===0&&(0,e.jsxs)("div",{className:"mt-10 flex flex-col items-center justify-center text-center",children:[(0,e.jsx)(k.Wanchain,{size:60,className:"text-purple-600 dark:text-purple-600 mb-2",variant:"Bold"}),(0,e.jsx)("div",{className:"text-lg font-bold text-purple-600",children:"Hello, there...! \u{1F44B}"}),(0,e.jsx)("div",{className:"mt-1 font-semibold text-gray-500 dark:text-gray-400 text-sm",children:"How can I help you today?"})]}),c.map((t,r)=>(0,e.jsxs)("div",{className:`flex items-end gap-2 ${t.sender==="user"?"justify-end":"justify-start"}`,children:[t.sender==="bot"&&(0,e.jsx)("div",{className:"flex items-end relative",children:(0,e.jsx)(k.Wanchain,{className:"h-[31px] w-[31px] text-purple-600 dark:text-purple-600 border border-purple-600 rounded-full p-1",variant:"Bold"})}),(0,e.jsxs)("div",{className:`px-3 py-2 rounded-2xl max-w-[75%] text-sm shadow-sm break-words ${t.sender==="user"?"bg-purple-600 text-white rounded-br-none":"bg-gray-200 dark:bg-neutral-600 text-gray-800 dark:text-white rounded-bl-none"}`,children:[t.isTyping?(0,e.jsxs)("div",{className:"flex gap-1 px-1.5",children:[(0,e.jsx)("span",{className:"w-1.5 h-1.5 bg-gray-600 rounded-full animate-bounce"}),(0,e.jsx)("span",{className:"w-1.5 h-1.5 bg-gray-600 rounded-full animate-bounce delay-200"}),(0,e.jsx)("span",{className:"w-1.5 h-1.5 bg-gray-600 rounded-full animate-bounce delay-400"})]}):(0,e.jsxs)("div",{children:[t.text&&(0,e.jsx)("span",{children:t.text}),t.uploaded_documents&&(0,e.jsx)("div",{className:"mt-2",children:/\.(jpg|jpeg|png|gif)$/i.test(t.uploaded_documents)?(0,e.jsx)("a",{href:t.uploaded_documents,target:"_blank",rel:"noopener noreferrer",className:"text-gray-200 text-xs",children:(0,e.jsx)("img",{src:t.uploaded_documents,alt:"Uploaded",width:180,height:120,className:"rounded-lg border border-zinc-200 dark:border-neutral-700"})}):/\.(mp3|wav|ogg)$/i.test(t.uploaded_documents)||t.uploaded_documents.includes("audio")?(0,e.jsx)("audio",{controls:!0,className:"mt-1 w-full",children:(0,e.jsx)("source",{src:t.uploaded_documents})}):(0,e.jsx)("a",{href:t.uploaded_documents,target:"_blank",rel:"noopener noreferrer",className:"text-gray-200",children:(0,e.jsxs)("div",{className:"flex gap-2",children:[" ",(0,e.jsx)(x.FileText,{size:20}),"View Document"]})})})]}),t.sender==="user"&&(0,e.jsx)("span",{className:"ml-1 text-[10px] opacity-70 bottom-1 right-2 whitespace-nowrap",children:t.timestamps?.sent||t.timestamps?.received||"Just now"}),t.sender==="bot"&&t.timestamps?.received&&(0,e.jsx)("span",{className:"ml-1 text-[10px] opacity-70 bottom-1 right-2 whitespace-nowrap",children:t.timestamps.received})]}),t.sender==="user"&&(0,e.jsx)("div",{className:"flex-shrink-0 relative flex items-center justify-center bg-purple-600  rounded-full h-[30px] w-[30px]",children:(0,e.jsx)(k.User,{size:"18",className:"text-gray-200",variant:"Bold"})})]},r)),(0,e.jsx)("div",{ref:v})]}),(0,e.jsxs)("div",{className:"flex items-center border-t border-zinc-200 dark:border-neutral-700 p-3",children:[(0,e.jsx)("input",{type:"file",id:"hostieFileInput",className:"hidden",onChange:t=>{t.target.files&&t.target.files[0]&&W(t.target.files[0])}}),(0,e.jsx)("button",{onClick:()=>document.getElementById("hostieFileInput")?.click(),className:"flex items-center justify-center h-9 w-9 rounded-full border border-zinc-200 dark:border-neutral-700 text-zinc-500 dark:text-zinc-400 mr-2",children:(0,e.jsx)(x.Plus,{className:"w-4 h-4"})}),(0,e.jsx)("input",{type:"text",value:i,onChange:t=>s(t.target.value),onKeyDown:t=>t.key==="Enter"&&F(),placeholder:"Ask your question",className:"flex-1 outline-none border border-zinc-200 dark:border-neutral-700 rounded-full px-3 py-2 text-sm focus:ring-1 focus:ring-purple-600"}),(0,e.jsx)("button",{onClick:F,className:"flex items-center justify-center h-9 w-9 rounded-full bg-gradient-to-r from-purple-600 to-purple-700 text-white ml-2",children:(0,e.jsx)(x.SendHorizonal,{className:"w-4 h-4"})})]}),(0,e.jsx)("div",{className:"text-center text-xs text-zinc-400 py-2",children:"Hostie may produce inaccurate information"})]})})}var H={};var m=require("react/jsx-runtime");function st(o,n){(0,h.useEffect)(()=>{if(o.current){let i=o.current.attachShadow({mode:"open"}),s=document.createElement("style");s.textContent=n,i.appendChild(s);let c=o.current.querySelector("#chat-ui-content");c&&i.appendChild(c)}},[n,o])}function T({apiKey:o,openAi:n}){let[i,s]=(0,h.useState)(!1),c=(0,h.useRef)(null),[u,v]=(0,h.useState)(null),I="https://hostie-dashboard.vercel.app/api/clientCustomerChatBox";(0,h.useEffect)(()=>{(async()=>{try{let b=await fetch(`${I}/verifyDomain`,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json","x-api-key":o},body:JSON.stringify({api_key:o})});if(!b.ok){v(!1);return}let _=await b.json();v(_.allowed??!1)}catch(b){console.error("Domain verification failed:",b),v(!1)}})()},[o]),(0,h.useEffect)(()=>{let y=b=>{c.current&&!c.current.contains(b.target)&&s(!1)};return document.addEventListener("mousedown",y),()=>document.removeEventListener("mousedown",y)},[]);let z=(0,h.useRef)(null);return st(z,H),u===null?null:u===!1?(0,m.jsxs)("div",{className:"fixed bottom-6 right-6 z-[9999] text-sm text-red-600 bg-white p-3 rounded-xl shadow",children:[(0,m.jsx)("p",{className:"text-gray-600 text-sm",children:"This chat widget is not authorized for this domain."}),(0,m.jsx)("p",{className:"text-gray-400 text-xs mt-2",children:"Please contact your site administrator to enable access."})]}):(0,m.jsx)("div",{ref:z,style:{position:"fixed",bottom:"1.5rem",right:"1.5rem",zIndex:9999},children:(0,m.jsx)("div",{id:"chat-ui-content",children:(0,m.jsxs)("div",{ref:c,children:[(0,m.jsxs)("button",{onClick:()=>s(!i),className:`rounded-full shadow-xl flex items-center gap-2 px-4 py-2 bg-purple-600 bg-gradient-to-r from-purple-700 to-purple-500 text-white \r
           hover:from-purple-800 hover:to-purple-600 `,children:[(0,m.jsx)(P.Wanchain1,{size:"22"}),(0,m.jsx)("span",{className:"font-semibold text-sm",children:"Ask Hostie!"})]}),i&&(0,m.jsx)("div",{className:"absolute bottom-full mb-3 right-0 w-80 p-0 shadow-2xl border border-gray-200 transition-all duration-200 rounded-xl bg-white",children:(0,m.jsx)($,{apiKey:o,openAi:n})})]})})})}var B=require("react/jsx-runtime");function R({apiKey:o,openAi:n,containerId:i="hostie-chat-root"}){let s=document.getElementById(i);s||(s=document.createElement("div"),s.id=i,document.body.appendChild(s)),Y.default.createRoot(s).render((0,B.jsx)(T,{apiKey:o,openAi:n}))}if(typeof window<"u"){let o=document.currentScript;if(o){let n=o.getAttribute("data-api-key"),i=o.getAttribute("data-openai"),s=o.getAttribute("data-id")||"hostie-chat-root";n&&R({apiKey:n,openAi:i||void 0,containerId:s})}window.HostieChat={init:R}}0&&(module.exports={ChatUI,init});
//# sourceMappingURL=index.cjs.map