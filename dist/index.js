import nt from"react-dom/client";import{useState as $,useRef as H,useEffect as T}from"react";import{Wanchain1 as at}from"iconsax-react";import{useState as m,useEffect as S,useRef as Q}from"react";import{Bot as Z,FileText as K,Plus as tt,SendHorizonal as et}from"lucide-react";import{User as rt,Wanchain as _}from"iconsax-react";import{jsx as o,jsxs as w}from"react/jsx-runtime";function F({apiKey:a,openAi:p}){let[n,s]=m(""),[g,h]=m([]),y=Q(null),[C,v]=m(""),[k,x]=m(null),[u,N]=m(!1),[l,I]=m(null),[z,R]=m(()=>sessionStorage.getItem("aiPaused")==="true"),[M,B]=m(null),[E,X]=m(!1);S(()=>{sessionStorage.setItem("aiPaused",z.toString())},[z]);let b="https://hostie-dashboard.vercel.app/api/clientCustomerChatBox";S(()=>{y.current?.scrollIntoView({behavior:"smooth"})},[g]),S(()=>{(async()=>{try{let e=sessionStorage.getItem("guestContactId"),r=sessionStorage.getItem("room"),d=sessionStorage.getItem("guestContactId");if(e){v(e),x(e);let i=await(await fetch(`${b}/getGuestRoom?guest_id=${e}`,{headers:{"x-api-key":a}})).json();I(i.room_id)}else{let c=crypto.randomUUID();I(c),N(!0),x(null)}}catch(e){console.error("Error setting up room:",e)}})()},[]),S(()=>{(async()=>{if(l&&C)try{let e=await fetch(`${b}/getChatHistory?room_id=${l}`,{headers:{"x-api-key":a}}),r=await e.json();if(!e.ok){console.error("Failed to fetch chat history:",r.error);return}let c=(r.data||[]).filter(i=>!i.resolved&&!i.deleted).map(i=>({sender:i.sender_id||i.guest_sender_id?"user":"bot",text:i.message,uploaded_documents:i.uploaded_documents||null,timestamps:{sent:i.sender_id||i.guest_sender_id?new Date(i.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):void 0,received:!i.sender_id&&!i.guest_sender_id?new Date(i.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):void 0}}));h(c)}catch(e){console.error("Unexpected error fetching chat history:",e)}})()},[l]),S(()=>{if(!l)return;let t=new EventSource(`${b}/stream?room=${l}&api_key=${a}`);return t.onmessage=e=>{if(!(e.data==="ping"||e.data==="connected"))try{let r=JSON.parse(e.data);if(!r||!r.message||r.deleted)return;let d=r.message.trim();if(d==="You are now connected to a live agent. AI responses are paused."){R(!0),O(d);return}if(d==="AI responses resumed."){R(!1),O(d);return}h(c=>[...c,{sender:r.sender_id||r.guest_sender_id?"user":"bot",text:r.message,timestamps:{received:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}}])}catch(r){console.error("SSE parse error:",r)}},t.onerror=e=>{console.error("SSE connection error:",e),t.close()},()=>t.close()},[l]);let G=async t=>{let e=await fetch(`${b}/saveContact`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":a},body:JSON.stringify(t)});if(!e.ok){let d=await e.text();throw new Error(`Failed to save contact: ${e.status} ${d}`)}return await e.json()},A=async(t,e)=>(await fetch(`${b}/saveMessage`,{method:"POST",headers:{"Content-Type":"application/json","x-openai-key":p,"x-api-key":a},body:JSON.stringify({prompt:t,room_id:l,sender_id:k,receiver_id:z?"live_agent":"ai",skipAI:e})})).json(),J=async(t,e,r)=>(await fetch(`${b}/saveMessage`,{method:"POST",headers:{"Content-Type":"application/json","x-openai-key":p,"x-api-key":a},body:JSON.stringify({prompt:t,room_id:l,sender_id:r,receiver_id:z?"live_agent":"ai",skipAI:e})})).json(),U=async(t,e,r)=>{await fetch(`${b}/saveAiMessage`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":r},body:JSON.stringify({room_id:l,message:t,receiver_id:e})})},O=t=>{h(e=>[...e,{sender:"bot",text:t,timestamps:{received:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}}])},q=t=>{h(e=>[...e,{sender:"user",text:t,timestamps:{sent:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}}])},L=async()=>{if(!n.trim())return;let t=n.trim();if(s(""),u&&!M&&!E){q(t),X(!0),await U("Before we continue, could you please share your name or email?",k,a);return}if(E&&!M)if(l){let e=n.includes("@")?{email:n,room_id:l}:{name:n,room_id:l};try{let r=await G(e);sessionStorage.setItem("guestContactId",r.id),v(r.id),x(r.id),B({name:r.name,email:r.email}),sessionStorage.setItem("room",r.room_id),I(r.room_id),sessionStorage.setItem("guestContactId",r.id),await J(n,!0,r.id);let d=`Thanks ${r.name||r.email}! You can continue chatting now..!`;await U(d,r.id,a)}catch(r){console.error("Error saving guest info:",r)}return}else console.log("no room name there....");if(z){console.log("AI response paused due to live agent assignment.");let e=await A(t,!0)}else try{let r=(await A(t,!1)).reply||"Sorry, I couldn't generate a reply."}catch(e){console.error("AI call failed:",e)}},V=async t=>{if(!l||!k){alert("provide your details First..!");return}if(!["image/jpeg","image/png","image/gif","application/pdf","audio/mpeg","audio/wav","audio/ogg"].includes(t.type)){let c=t.type||t.name.split(".").pop();alert(`\u274C Unsupported file type: ${c}`);return}let r=50*1024*1024;if(t.size>r){alert(`\u274C File too large! (${(t.size/1024/1024).toFixed(1)} MB > 50 MB limit)`);return}let d=new FormData;d.append("file",t),d.append("room_id",l),d.append("sender_id",k);try{let c=await fetch(`${b}/uploadFile`,{method:"POST",headers:{"x-api-key":a},body:d}),i=await c.json();if(!c.ok){alert("File upload failed. Please try again."),console.error("Upload error:",i.error);return}if(!i.fileUrl){alert("Unexpected error: no file URL returned.");return}h(W=>[...W,{sender:"user",text:t.name,uploaded_documents:i.fileUrl,timestamps:{sent:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}}])}catch(c){console.error("File upload failed:",c),alert("Something went wrong while uploading. Please try again.")}};return o("div",{className:"fixed bottom-6 right-6 z-50",children:w("div",{id:"hostie-chat-box",className:"flex flex-col w-[340px] h-[85vh] rounded-2xl shadow-xl border border-zinc-200 bg-white dark:bg-neutral-800 overflow-hidden",children:[w("div",{className:"flex items-center justify-between p-3 border-b border-zinc-200 dark:border-neutral-700",children:[w("div",{className:"flex items-center gap-2",children:[o(_,{className:"text-purple-600",variant:"Bold"}),o("span",{className:"font-semibold text-sm",children:"Hostie"}),o("span",{className:"ml-1 h-2 w-2 rounded-full bg-green-500"}),o("span",{className:"text-xs text-green-500",children:"Online"})]}),w("div",{className:"flex items-center px-2 py-0.5 rounded-md bg-purple-50 dark:bg-purple-800",children:[o(Z,{size:12,className:"text-zinc-600 dark:text-zinc-200"}),o("span",{className:"ml-1 text-xs font-medium",children:"AI"})]})]}),w("div",{className:"flex-1 overflow-y-auto p-3 space-y-2",children:[g.length===0&&w("div",{className:"mt-10 flex flex-col items-center justify-center text-center",children:[o(_,{size:60,className:"text-purple-600 dark:text-purple-600 mb-2",variant:"Bold"}),o("div",{className:"text-lg font-bold text-purple-600",children:"Hello, there...! \u{1F44B}"}),o("div",{className:"mt-1 font-semibold text-gray-500 dark:text-gray-400 text-sm",children:"How can I help you today?"})]}),g.map((t,e)=>w("div",{className:`flex items-end gap-2 ${t.sender==="user"?"justify-end":"justify-start"}`,children:[t.sender==="bot"&&o("div",{className:"flex items-end relative",children:o(_,{className:"h-[31px] w-[31px] text-purple-600 dark:text-purple-600 border border-purple-600 rounded-full p-1",variant:"Bold"})}),w("div",{className:`px-3 py-2 rounded-2xl max-w-[75%] text-sm shadow-sm break-words ${t.sender==="user"?"bg-purple-600 text-white rounded-br-none":"bg-gray-200 dark:bg-neutral-600 text-gray-800 dark:text-white rounded-bl-none"}`,children:[t.isTyping?w("div",{className:"flex gap-1 px-1.5",children:[o("span",{className:"w-1.5 h-1.5 bg-gray-600 rounded-full animate-bounce"}),o("span",{className:"w-1.5 h-1.5 bg-gray-600 rounded-full animate-bounce delay-200"}),o("span",{className:"w-1.5 h-1.5 bg-gray-600 rounded-full animate-bounce delay-400"})]}):w("div",{children:[t.text&&o("span",{children:t.text}),t.uploaded_documents&&o("div",{className:"mt-2",children:/\.(jpg|jpeg|png|gif)$/i.test(t.uploaded_documents)?o("a",{href:t.uploaded_documents,target:"_blank",rel:"noopener noreferrer",className:"text-gray-200 text-xs",children:o("img",{src:t.uploaded_documents,alt:"Uploaded",width:180,height:120,className:"rounded-lg border border-zinc-200 dark:border-neutral-700"})}):/\.(mp3|wav|ogg)$/i.test(t.uploaded_documents)||t.uploaded_documents.includes("audio")?o("audio",{controls:!0,className:"mt-1 w-full",children:o("source",{src:t.uploaded_documents})}):o("a",{href:t.uploaded_documents,target:"_blank",rel:"noopener noreferrer",className:"text-gray-200",children:w("div",{className:"flex gap-2",children:[" ",o(K,{size:20}),"View Document"]})})})]}),t.sender==="user"&&o("span",{className:"ml-1 text-[10px] opacity-70 bottom-1 right-2 whitespace-nowrap",children:t.timestamps?.sent||t.timestamps?.received||"Just now"}),t.sender==="bot"&&t.timestamps?.received&&o("span",{className:"ml-1 text-[10px] opacity-70 bottom-1 right-2 whitespace-nowrap",children:t.timestamps.received})]}),t.sender==="user"&&o("div",{className:"flex-shrink-0 relative flex items-center justify-center bg-purple-600  rounded-full h-[30px] w-[30px]",children:o(rt,{size:"18",className:"text-gray-200",variant:"Bold"})})]},e)),o("div",{ref:y})]}),w("div",{className:"flex items-center border-t border-zinc-200 dark:border-neutral-700 p-3",children:[o("input",{type:"file",id:"hostieFileInput",className:"hidden",onChange:t=>{t.target.files&&t.target.files[0]&&V(t.target.files[0])}}),o("button",{onClick:()=>document.getElementById("hostieFileInput")?.click(),className:"flex items-center justify-center h-9 w-9 rounded-full border border-zinc-200 dark:border-neutral-700 text-zinc-500 dark:text-zinc-400 mr-2",children:o(tt,{className:"w-4 h-4"})}),o("input",{type:"text",value:n,onChange:t=>s(t.target.value),onKeyDown:t=>t.key==="Enter"&&L(),placeholder:"Ask your question",className:"flex-1 outline-none border border-zinc-200 dark:border-neutral-700 rounded-full px-3 py-2 text-sm focus:ring-1 focus:ring-purple-600"}),o("button",{onClick:L,className:"flex items-center justify-center h-9 w-9 rounded-full bg-gradient-to-r from-purple-600 to-purple-700 text-white ml-2",children:o(et,{className:"w-4 h-4"})})]}),o("div",{className:"text-center text-xs text-zinc-400 py-2",children:"Hostie may produce inaccurate information"})]})})}var D={};import{jsx as f,jsxs as j}from"react/jsx-runtime";function it(a,p){T(()=>{if(a.current){let n=a.current.attachShadow({mode:"open"}),s=document.createElement("style");s.textContent=p,n.appendChild(s);let g=a.current.querySelector("#chat-ui-content");g&&n.appendChild(g)}},[p,a])}function P({apiKey:a,openAi:p}){let[n,s]=$(!1),g=H(null),[h,y]=$(null),C="https://hostie-dashboard.vercel.app/api/clientCustomerChatBox";T(()=>{(async()=>{try{let u=await fetch(`${C}/verifyDomain`,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json","x-api-key":a},body:JSON.stringify({api_key:a})});if(!u.ok){y(!1);return}let N=await u.json();y(N.allowed??!1)}catch(u){console.error("Domain verification failed:",u),y(!1)}})()},[a]),T(()=>{let x=u=>{g.current&&!g.current.contains(u.target)&&s(!1)};return document.addEventListener("mousedown",x),()=>document.removeEventListener("mousedown",x)},[]);let v=H(null);return it(v,D),h===null?null:h===!1?j("div",{className:"fixed bottom-6 right-6 z-[9999] text-sm text-red-600 bg-white p-3 rounded-xl shadow",children:[f("p",{className:"text-gray-600 text-sm",children:"This chat widget is not authorized for this domain."}),f("p",{className:"text-gray-400 text-xs mt-2",children:"Please contact your site administrator to enable access."})]}):f("div",{ref:v,style:{position:"fixed",bottom:"1.5rem",right:"1.5rem",zIndex:9999},children:f("div",{id:"chat-ui-content",children:j("div",{ref:g,children:[j("button",{onClick:()=>s(!n),className:`rounded-full shadow-xl flex items-center gap-2 px-4 py-2 bg-purple-600 bg-gradient-to-r from-purple-700 to-purple-500 text-white \r
           hover:from-purple-800 hover:to-purple-600 `,children:[f(at,{size:"22"}),f("span",{className:"font-semibold text-sm",children:"Ask Hostie!"})]}),n&&f("div",{className:"absolute bottom-full mb-3 right-0 w-80 p-0 shadow-2xl border border-gray-200 transition-all duration-200 rounded-xl bg-white",children:f(F,{apiKey:a,openAi:p})})]})})})}import{jsx as st}from"react/jsx-runtime";function Y({apiKey:a,openAi:p,containerId:n="hostie-chat-root"}){let s=document.getElementById(n);s||(s=document.createElement("div"),s.id=n,document.body.appendChild(s)),nt.createRoot(s).render(st(P,{apiKey:a,openAi:p}))}if(typeof window<"u"){let a=document.currentScript;if(a){let p=a.getAttribute("data-api-key"),n=a.getAttribute("data-openai"),s=a.getAttribute("data-id")||"hostie-chat-root";p&&Y({apiKey:p,openAi:n||void 0,containerId:s})}window.HostieChat={init:Y}}export{P as ChatUI,Y as init};
//# sourceMappingURL=index.js.map